name: Teams webhook test

on:
  push:
    branches: 
      - main
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    
jobs:
  teams-webhook-test:
    name: Teams webhook test(clone)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Checkout action repository
      uses: actions/checkout@v2
      with:
        repository: j-com-dev/notify-microsoft-teams
        token: ${{ secrets.ACTIONS_READ_PAT }}
        path: ./notify-microsoft-teams
    - run: |
        pwd
        ls -la
        ls -la notify-microsoft-teams

    - name: Upload action stript into artifact
      uses: actions/upload-artifact@v4
      with:
        name: notify-microsoft-teams
        path: ./notify-microsoft-teams/*

  dosomething:
    name: Error
    runs-on: ubuntu-latest
    needs: teams-webhook-test
    steps:
    - run: cat xxx.txt
  
  notify:
    name: Teams webhook test(notify)
    runs-on: ubuntu-latest
    needs: dosomething
    if: always()
    steps:
    - name: Download bicep script from artifact
      uses: actions/download-artifact@v4
      with:
        name: notify-microsoft-teams
        path: ./notify-microsoft-teams
    - run: |
        pwd
        ls -la
        ls -la notify-microsoft-teams
    - name: Microsoft Teams Notification
      # uses: skitionek/notify-microsoft-teams@master
      uses: ./notify-microsoft-teams
      if: success()
      with:
        webhook_url: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
        needs: ${{ toJson(needs) }}
        job: ${{ toJson(job) }}
        steps: ${{ toJson(steps) }}
    
    - name: Microsoft Teams Notification
      # uses: skitionek/notify-microsoft-teams@master
      uses: ./notify-microsoft-teams
      if: failure()
      with:
        webhook_url: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
        job: ${{ toJson(job) }}
        steps: ${{ toJson(steps) }}
        msteams_emails: "watanabekazuhi@jupiter.jcom.co.jp"
        # title: "**${{ github.workflow }}** 実行中にエラーが発生しました"